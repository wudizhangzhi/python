#!/usr/bin/python
# coding=utf-8

# from qq.view.base_view.py import base_view
import sys

sys.path.append('..')
from view.base_view import BaseView
from view.sets import *
from utils.methods import get_all_log
import sqlite3
import subprocess
import re


# log文件显示行数
# line_show = 15
# log_list = ['nginx', 'httpd', 'mysqld','mongodb', 'redis','sys']

# line_help = 'q--返回上一页,退出  o--输出日志  空格--进入  m--标记  k--向下  j--向上'

# version = 'Linux&&Unix日志取证大师V1.0'

# tab = '\033[36m✔ \033[0m'

class Login(BaseView):
    '''
    自定义选择界面
    '''

    def __init__(self):
        super(Login, self).__init__()
        self.title = '自定义选择界面'
        self.content = '请选择...'
        self.log_name = ''
        self.content_main = ['\r']
        # 指针
        self.select = 0
        # 指针范围
        self.select_range = len(log_list) - 1
        self.logshow = False
        # log文件开始坐标
        self.logshow_start = 0
        self.logfile = ['无']
        # 具体文件的标记
        self.mark = {'nginx': [], 'httpd': [], 'mysqld': [], 'mongodb': [], 'redis': [], 'sys': []}
        # 主页面的标记
        self.mark_main = []
        # 是否正在进行数据库操作
        self.working = False
        #
        self._initSysInfo()
        # self.memuse, self.memtotal = calcMemUsage()

    # def _initSysInfo(self):
    #     memuse, memtotal = calcMemUsage()
    #     import platform
    #     l = ['系统版本: ' + ' '.join(platform.linux_distribution()) + '\r']
    #     l.append('CPU 架构: '+ str(platform.machine()) + '\r')
    #     p = subprocess.Popen('cat /proc/cpuinfo | grep "^model name" | head -1 | awk -F ":" \'{print $2}\'', stdout=subprocess.PIPE,shell=True)
    #     ret = p.communicate()
    #     infos = []
    #     if ret:
    #         for info in set(re.sub(r' ', '', ret[0]).split('\n')):
    #             if info:
    #                 infos.append(info)
    #     l.append('内存使用: ' + str(memuse / 1024) + ' Mb\r')
    #     l.append('内存总量: ' + str(memtotal / 1024) + ' Mb\r')
    #     l.append('CPU 型号: ' + str(infos[0]) + '\r')
    #     self.sysinfo = l

    def make_displaylines(self):
        self.screen_height, self.screen_width = self.linesnum()
        display_lines = ['\r']
        # display_lines.append('')
        # display_lines.append(version + '\r')
        # display_lines.append('')
        width_sys = len(self.sysinfo[0].decode('utf8'))
        self.left_margin = self.screen_width / 2 - width_sys / 2
        for i in self.sysinfo:
            display_lines.append(' ' * self.left_margin + i)
        display_lines.append('')
        display_lines.append(' ' * self.left_margin + self.title + ' ' * 10 + self.log_name + '\r')
        display_lines.append('')

        display_lines.append(' ' * self.left_margin + self.content + str(self.select) + '\r')
        if not self.logshow:
            # 重置指针范围
            self.select_range = len(log_list)
            for i in range(len(log_list)):
                if i == self.select:
                    line = '->' + ' ' * 10 + '\033[42;37m' + log_list[i] + '\033[0m'
                    # display_lines.append('->' +' '*10 +log_list[i]+ '\r')
                else:
                    line = ' ' * 12 + log_list[i]
                    # display_lines.append(' '*12 +log_list[i]+ '\r')
                if i in self.mark_main:  # 标记
                    # line += '   \033[36m✔ \033[0m'
                    line += ('    ' + tab)
                line += '\r'
                display_lines.append(' ' * self.left_margin + line)

        else:  # 显示具体文件内容
            # log = get_all_log()[log_list[self.select]]
            self.select_range = len(self.logfile)
            # 显示的部分
            if self.select > line_show - 1:
                self.logshow_start = self.select - line_show + 1
            if self.select < line_show:
                self.logshow_start = 0

            if self.select_range < line_show:
                logshow_end = self.select_range
            else:
                logshow_end = self.logshow_start + line_show
            for i in range(self.logshow_start, logshow_end):
                if i == self.select:
                    line = '->' + ' ' * 10 + self.logfile[i]
                else:
                    line = ' ' * 12 + self.logfile[i]
                if i in self.mark[self.log_name]:  # 标记
                    # line += '    \033[36m√ \033[0m'
                    line += ('    ' + tab)
                line += '\r'
                display_lines.append(' ' * self.left_margin + line)
        # display_lines.append(' ' * 12 + str(self.select) + '\r')

        display_lines.append('')
        for i in range(self.screen_height - len(display_lines) - 2):
            display_lines.append('')
        # 帮助信息
        display_lines.append(line_help_logview)
        display_lines.append('\r')
        self.display_lines = display_lines

    def display(self):
        self.make_displaylines()
        print '\n'.join(self.display_lines)

    def move(self, step):
        num = self.select + step
        if num < 0:
            self.select = 0
        elif num > self.select_range - 1:
            self.select = self.select_range - 1
        else:
            self.select = num

    def changelogfile(self, logfile):
        self.logfile = logfile

    def marking(self):
        if not self.working:
            self.working = True
            db = sqlite3.connect('db/loginfo.db')
            cur = db.cursor()
            if self.logshow:
                filename = self.logfile[self.select]
                if self.select in self.mark[self.log_name]:
                    self.mark[self.log_name].remove(self.select)
                    cur.execute('delete from log_select where name="%s"' % filename)
                else:
                    self.mark[self.log_name].append(self.select)
                    filename = self.logfile[self.select]
                    cur.execute('insert into log_select(name) values("%s")' % filename)
            else:
                data = get_all_log()[log_list[self.select]]
                r = []
                for i in data:
                    t = []
                    t.append(i)
                    r.append(t)
                if r and r[0][0] != '无':
                    if self.select in self.mark_main:
                        self.mark_main.remove(self.select)
                        cur.executemany('DELETE FROM log_select WHERE name=?', r)
                    else:
                        self.mark_main.append(self.select)
                        cur.executemany('INSERT INTO log_select(name) VALUES(?)', r)
            db.commit()
            cur.close()
            db.close()
            self.working = False


if __name__ == '__main__':
    win = Login()
    win.display()
